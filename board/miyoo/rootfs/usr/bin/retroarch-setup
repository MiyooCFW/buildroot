#!/bin/sh

##imported env variables are upper-cased:
###${HOME}
###${FRONTEND}
###${FRONTEND_WDIR}

while getopts "rc:" opt; do
  case "$opt" in
    r)
      #Option -r for Rewind
      ra_rewind="true"
      ;;
    c)
      #Option -c for Custom *.cfg with parsed value"
      ra_custom_cfg="$OPTARG"
      ;;
    \?)
      echo "Usage: $0 [-r] [-c <retroarch.cfg>] <menu(default)|kiosk|minimal|history|update>" >&2
      exit 1
      ;;
  esac
done

shift $((OPTIND - 1))

#First argument is a non-option value"
ra_mode="${1}" # (default=menu); history; kiosk; minimal;
frontend_alive="${FRONTEND}" # (default="") thus no frontend
frontend_wdir="${FRONTEND_WDIR}"

ra_path="${HOME}/emus/retroarch"
ra_config_path="${HOME}/.retroarch"
history_path="${ra_config_path}/playlists/builtin/content_history.lpl" ## RA ver. >1.22.2

cd "${ra_path}" || { echo -en "Failed to cd into ${ra_path}, no RetroArch to launch.\n\nEXITING..." ; exit; }

if test "${ra_mode}" == "history"; then
  if test -f "${history_path}"; then
    rom_path="$(head -n20 "${history_path}" | grep -Eo -m1 '/roms/[^"]+')"
    core_path="$(head -n20 "${history_path}" | grep -Eo -m1 "${ra_config_path}/cores/.+\.so")"
    if test -f "${core_path}" -a -f "${rom_path}"; then
      ./retroarch --libretro "${core_path}" "${rom_path}"
    else
      echo -e "ERROR: ROM file in $rom_path or libretro CORE in $core_path does not exist"
      exit 1
    fi
  else
    echo -e "ERROR: history file $history_path does not exist"
    exit 1
  fi
  exit 0
elif test "${ra_mode}" == "update"; then
  if test -e "${ra_path}/retroarch"; then
    ## Generate list of cores to be used
    cores_dir="${HOME}/.retroarch/cores"
    for file in $cores_dir/*; do
      if test -f "$file"; then
        core_file="$(echo "$file" | sed 's/.*\///')"
        core_name="$(echo "${core_file}" | sed 's/_libretro.so//g')"
        if test "${frontend_alive}" == "gmenu2x"; then
          test -z "${frontend_wdir}" \
           && frontend_wdir="${HOME}/gmenu2x" ## WIP: assuming gmenu2x is placed at /mnt/gmenu2x
          # sanity check if there's an existing link in gmenu2x
          ra_ldir="${frontend_wdir}/sections/cores"
          test -d $ra_ldir || mkdir $ra_ldir
          core_link="${core_name}.ra"
          if ! test -e "${ra_ldir}"/*"${core_link}"; then
            { echo -e "title=${core_name}\ndescription=${core_name} libretro core\nexec=${ra_path}/retroarch\nselectordir=/mnt\nparams=-vL ${core_name} --appendconfig=${ra_path}/retroarch_menu.cfg" \
            > "${ra_ldir}"/"${core_link}" \
            && echo -en "\nGenarated link of core: ${core_name}"; } \
            || echo -en "\nWARNING: There was an issue for link of core: ${core_name}"
            #mv ${ra_ldir}/${core_link} ${ra_ldir}/zblank.${core_link}
          fi
        else
          echo -e "ERROR: Unknown defined FRONTEND=${FRONTEND}, not going to update core links cuz of missing frontend_alive..."
          exit 1
        fi
      fi
    done
  else
    echo -en "\nERROR: Did not find ${ra_path}/retroarch for links setup..."
    exit 1
    #test -d $ra_path && rm -rf $ra_path
  fi
  exit 0
else
  if test "${ra_mode}" == "kiosk"; then
    ra_append_cfg="${ra_path}/retroarch_kiosk.cfg"
  elif test "${ra_mode}" == "minimal"; then
    ra_append_cfg="${ra_path}/retroarch_minimal.cfg"
  elif ! test -z "${ra_mode}" && ! test "${ra_mode}" == "menu"; then
    echo -e "\nERROR: wrong option ${ra_mode} argument passed"
    exit 1;
  else #menu
    ra_append_cfg="${ra_path}/retroarch_menu.cfg"
  fi

  test "${ra_rewind}" == "true" &&
   ra_append_cfg="${ra_append_cfg}\|${ra_path}/retroarch_rewind.cfg"
  test -f "${ra_custom_cfg}" &&
   ra_append_cfg="${ra_append_cfg}\|${ra_custom_cfg}"
  #Apply new setting to frontend
  if test "${frontend_alive}" == "gmenu2x"; then
    if test -d "${HOME}/gmenu2x/sections/cores"; then
      cores_path="${HOME}/gmenu2x/sections/cores"
    elif test -d "${HOME}/gmenu2x/sections/.cores"; then
      cores_path="${HOME}/gmenu2x/sections/.cores"
    fi
    if test -d "${cores_path}"; then
      for file in "${cores_path}"/*; do
        if grep -q '^params=' "$file"; then
          #Warning: escape "-" sign for grep cmd in BB otherwise it will fail,
          ## also in POSIX using ":" is safer delimer than "/" or "|" since paths or cmds can contain these also (likewise here)
          ##Below former sed cmd replaces first occurence of appendconfig, append "g" for global
          { grep -q '\--appendconfig=' "$file" \
          && sed -i "s:--appendconfig=[^[:space:]]*:--appendconfig=\"${ra_append_cfg}\":" "$file"; } \
          || sed -i "/^params=/ s:$: --appendconfig=\"${ra_append_cfg}\":" "$file"
        else
          echo "params=--appendconfig=\"${ra_append_cfg}\"" >> "$file"
        fi
      done
    else
      echo -en "\nERROR:No \"cores\" section in GMenu2X to apply config for libretro implementation."
      exit 1;
    fi
# elif test "${frontend_alive}" == "some_frontend"; then
  else
    #Assuming you have "config_save_on_exit=true" set in your custom RA config file
    (sleep 6; killall retroarch) &
    ./retroarch --appendconfig "${ra_append_cfg}"
  fi
  exit 0
fi